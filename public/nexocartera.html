<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexoCartera ‚Äî Dashboard para Distribuidores</title>
    <meta name="description" content="Gesti√≥n inteligente de cartera de clientes para distribuidores ‚Äî NexoFinanzas">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-base: #06080D;
            --bg-dark: #0B0E14;
            --bg-card: #111623;
            --bg-card-2: #161C2E;
            --bg-hover: #1A2038;
            --bg-input: #1B2236;
            --border: rgba(255, 255, 255, 0.06);
            --border-hover: rgba(0, 210, 160, 0.35);
            --glass: rgba(17, 22, 35, 0.75);
            --text-primary: #F0F2F5;
            --text-secondary: #8B95A5;
            --text-muted: #4D5668;
            --accent: #00D2A0;
            --accent-light: #5EFCE8;
            --accent-glow: rgba(0, 210, 160, 0.12);
            --purple: #6C5CE7;
            --purple-bg: rgba(108, 92, 231, 0.12);
            --green: #00D2A0;
            --green-bg: rgba(0, 210, 160, 0.1);
            --red: #FF6B6B;
            --red-bg: rgba(255, 107, 107, 0.1);
            --yellow: #FECA57;
            --yellow-bg: rgba(254, 202, 87, 0.1);
            --blue: #48DBFB;
            --blue-bg: rgba(72, 219, 251, 0.1);
            --orange: #FF9F43;
            --orange-bg: rgba(255, 159, 67, 0.1);
            --radius: 16px;
            --radius-sm: 10px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden
        }

        /* SIDEBAR */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 72px;
            background: var(--bg-dark);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 0;
            z-index: 200
        }

        .sidebar-logo {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--accent), #00b894);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 32px;
            box-shadow: 0 4px 20px rgba(0, 210, 160, 0.3)
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1
        }

        .nav-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            transition: all .2s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative
        }

        .nav-btn:hover,
        .nav-btn.active {
            background: var(--accent-glow);
            color: var(--accent-light)
        }

        .nav-btn.active::before {
            content: '';
            position: absolute;
            left: -16px;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 20px;
            background: var(--accent);
            border-radius: 0 3px 3px 0
        }

        .nav-btn .tip {
            position: absolute;
            left: 60px;
            background: var(--bg-card-2);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: .72rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity .15s;
            border: 1px solid var(--border)
        }

        .nav-btn:hover .tip {
            opacity: 1
        }

        /* HEADER */
        .header {
            position: fixed;
            top: 0;
            left: 72px;
            right: 0;
            height: 64px;
            background: rgba(11, 14, 20, 0.85);
            backdrop-filter: blur(24px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 28px;
            z-index: 150
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 14px
        }

        .header-left h2 {
            font-size: 1.05rem;
            font-weight: 700
        }

        .header-left h2 span {
            background: linear-gradient(135deg, var(--accent-light), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .h-btn {
            height: 36px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-secondary);
            font-size: .78rem;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 14px;
            transition: all .2s
        }

        .h-btn:hover {
            border-color: var(--accent);
            color: var(--accent-light);
            background: var(--accent-glow)
        }

        .h-btn.primary {
            background: linear-gradient(135deg, var(--accent), #00b894);
            border: none;
            color: #000;
            font-weight: 600
        }

        .h-btn.primary:hover {
            opacity: .85;
            transform: translateY(-1px)
        }

        .pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: .72rem;
            font-weight: 600
        }

        .pill.live {
            background: var(--green-bg);
            color: var(--green)
        }

        .pill .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--green);
            animation: pulse 2s infinite
        }

        /* MAIN */
        .main {
            margin-left: 72px;
            padding: 88px 28px 28px
        }

        /* WELCOME */
        .welcome-row {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            margin-bottom: 24px
        }

        .welcome h1 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 2px
        }

        .welcome h1 em {
            font-style: normal;
            background: linear-gradient(135deg, var(--accent-light), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .welcome p {
            color: var(--text-secondary);
            font-size: .85rem
        }

        /* STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 14px;
            margin-bottom: 22px
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px;
            transition: all .3s;
            position: relative;
            overflow: hidden;
            cursor: default
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px
        }

        .stat-card:nth-child(1)::after {
            background: linear-gradient(90deg, var(--accent), var(--blue))
        }

        .stat-card:nth-child(2)::after {
            background: linear-gradient(90deg, var(--purple), #a29bfe)
        }

        .stat-card:nth-child(3)::after {
            background: linear-gradient(90deg, var(--green), #00cec9)
        }

        .stat-card:nth-child(4)::after {
            background: linear-gradient(90deg, var(--red), var(--orange))
        }

        .stat-card:nth-child(5)::after {
            background: linear-gradient(90deg, var(--blue), var(--purple))
        }

        .stat-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(0, 210, 160, 0.08)
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            margin-bottom: 10px
        }

        .stat-val {
            font-size: 1.35rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 3px;
            font-variant-numeric: tabular-nums
        }

        .stat-lbl {
            font-size: .73rem;
            color: var(--text-secondary);
            font-weight: 500
        }

        /* GRID */
        .grid-2 {
            display: grid;
            grid-template-columns: 1.6fr 1fr;
            gap: 16px;
            margin-bottom: 16px
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px
        }

        .grid-2-eq {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px
        }

        /* PANEL */
        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 22px;
            transition: border .3s
        }

        .panel:hover {
            border-color: rgba(255, 255, 255, 0.08)
        }

        .panel-hdr {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px
        }

        .panel-title {
            font-size: .92rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .badge {
            font-size: .66rem;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 10px
        }

        .badge.g {
            background: var(--green-bg);
            color: var(--green)
        }

        .badge.r {
            background: var(--red-bg);
            color: var(--red)
        }

        .badge.p {
            background: var(--purple-bg);
            color: #a29bfe
        }

        .badge.b {
            background: var(--blue-bg);
            color: var(--blue)
        }

        /* TABLE */
        .tbl {
            width: 100%;
            border-collapse: collapse
        }

        .tbl th {
            text-align: left;
            font-size: .66rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .04em;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border)
        }

        .tbl td {
            padding: 10px;
            font-size: .8rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            vertical-align: middle
        }

        .tbl tr:hover td {
            background: rgba(255, 255, 255, 0.02)
        }

        .tbl .name-cell {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: .75rem;
            flex-shrink: 0
        }

        .tier-badge {
            font-size: .65rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 6px;
            letter-spacing: .03em
        }

        .tier-A {
            background: rgba(0, 210, 160, 0.15);
            color: #00D2A0
        }

        .tier-B {
            background: rgba(72, 219, 251, 0.15);
            color: #48DBFB
        }

        .tier-C {
            background: rgba(254, 202, 87, 0.15);
            color: #FECA57
        }

        .tier-D {
            background: rgba(255, 159, 67, 0.15);
            color: #FF9F43
        }

        .tier-F {
            background: rgba(255, 107, 107, 0.15);
            color: #FF6B6B
        }

        .score-bar {
            width: 60px;
            height: 5px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 3px;
            overflow: hidden
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width .6s
        }

        .risk-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block
        }

        /* CHART */
        .chart-box {
            height: 220px;
            position: relative
        }

        /* SEARCH */
        .search-box {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0 12px;
            transition: border .2s
        }

        .search-box:focus-within {
            border-color: var(--accent)
        }

        .search-box input {
            background: none;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: .8rem;
            font-family: inherit;
            padding: 8px 0;
            width: 180px
        }

        .search-box input::placeholder {
            color: var(--text-muted)
        }

        /* SCORE RING SMALL */
        .score-mini {
            display: flex;
            align-items: center;
            gap: 6px
        }

        .score-mini .num {
            font-weight: 800;
            font-size: .82rem;
            font-variant-numeric: tabular-nums
        }

        /* ALERTS */
        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03)
        }

        .alert-item:last-child {
            border-bottom: none
        }

        .alert-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .75rem;
            flex-shrink: 0
        }

        .alert-text {
            font-size: .78rem;
            color: var(--text-secondary);
            line-height: 1.4
        }

        .alert-text strong {
            color: var(--text-primary);
            font-weight: 600
        }

        .alert-time {
            font-size: .65rem;
            color: var(--text-muted);
            margin-top: 2px
        }

        /* TIER DISTRIBUTION */
        .tier-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0
        }

        .tier-row .label {
            width: 24px;
            font-weight: 700;
            font-size: .8rem
        }

        .tier-bar {
            flex: 1;
            height: 22px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 6px;
            overflow: hidden;
            position: relative
        }

        .tier-bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width .8s ease;
            display: flex;
            align-items: center;
            padding-left: 8px;
            font-size: .65rem;
            font-weight: 600;
            color: #000
        }

        .tier-row .count {
            font-size: .75rem;
            color: var(--text-secondary);
            width: 40px;
            text-align: right
        }

        /* LOADING */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 100px
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin .7s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .35
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(12px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .anim {
            animation: fadeIn .5s ease forwards
        }

        /* EMPTY */
        .empty {
            text-align: center;
            padding: 40px 24px;
            color: var(--text-muted)
        }

        .empty .ico {
            font-size: 2.2rem;
            margin-bottom: 10px
        }

        .empty h3 {
            font-size: .95rem;
            color: var(--text-secondary);
            margin-bottom: 4px
        }

        .empty p {
            font-size: .8rem
        }

        /* MODAL OVERLAY */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 500;
            display: none;
            align-items: center;
            justify-content: center
        }

        .modal-overlay.show {
            display: flex
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            width: 560px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 28px
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer
        }

        /* RESPONSIVE */
        @media(max-width:1400px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr)
            }
        }

        @media(max-width:1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr)
            }

            .grid-2,
            .grid-3,
            .grid-2-eq {
                grid-template-columns: 1fr
            }
        }

        @media(max-width:768px) {
            .sidebar {
                width: 0;
                overflow: hidden
            }

            .main {
                margin-left: 0;
                padding: 80px 16px 16px
            }

            .header {
                left: 0;
                padding: 0 16px
            }

            .stats-grid {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-logo">üìä</div>
        <nav class="sidebar-nav">
            <button class="nav-btn active" id="navPortfolio"><span>üè¢</span><span class="tip">Cartera</span></button>
            <button class="nav-btn" id="navScoring"><span>üéØ</span><span class="tip">Scoring</span></button>
            <button class="nav-btn" id="navAlerts"><span>üîî</span><span class="tip">Alertas</span></button>
            <button class="nav-btn" id="navReports"><span>üìà</span><span class="tip">Reportes</span></button>
        </nav>
        <div style="margin-top:auto;display:flex;flex-direction:column;gap:8px">
            <button class="nav-btn" onclick="window.location.href='/dashboard.html'"><span>üîô</span><span
                    class="tip">Dashboard Comerciante</span></button>
        </div>
    </aside>

    <header class="header">
        <div class="header-left">
            <h2>üè¢ <span>NexoCartera</span> ‚Äî Panel Distribuidor</h2>
        </div>
        <div class="header-right">
            <div class="search-box"><span>üîç</span><input type="text" id="searchInput"
                    placeholder="Buscar comerciante..."></div>
            <button class="h-btn" id="refreshBtn" title="Actualizar">üîÑ Actualizar</button>
            <button class="h-btn" id="recalcBtn" title="Recalcular scores">üéØ Recalcular</button>
            <div class="pill live">
                <div class="dot"></div><span>En l√≠nea</span>
            </div>
        </div>
    </header>

    <main class="main" id="mainContent">
        <div class="loading">
            <div class="spinner"></div>
        </div>
    </main>

    <!-- Merchant Detail Modal -->
    <div class="modal-overlay" id="merchantModal">
        <div class="modal" style="position:relative">
            <button class="modal-close" onclick="closeModal()">‚úï</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        const API = window.location.origin;
        let allMerchants = [];
        let distChart = null, trendChart = null;

        // ‚îÄ‚îÄ‚îÄ FORMATTERS ‚îÄ‚îÄ‚îÄ
        function fPYG(n) { if (!n) return 'Gs. 0'; if (n >= 1e6) return `Gs. ${(n / 1e6).toFixed(1)}M`; if (n >= 1e3) return `Gs. ${Math.round(n / 1e3)}K`; return `Gs. ${n.toLocaleString('es-PY')}` }
        function fDate(d) { if (!d) return '-'; return new Date(d).toLocaleDateString('es-PY', { day: '2-digit', month: 'short', year: 'numeric' }) }
        function timeAgo(d) { if (!d) return ''; const s = Math.floor((Date.now() - new Date(d)) / 1000); if (s < 60) return 'ahora'; if (s < 3600) return `${Math.floor(s / 60)}m`; if (s < 86400) return `${Math.floor(s / 3600)}h`; return `${Math.floor(s / 86400)}d` }
        function tierOf(score) { if (score >= 750) return 'A'; if (score >= 600) return 'B'; if (score >= 450) return 'C'; if (score >= 300) return 'D'; return 'F' }
        function tierColor(t) { return { A: '#00D2A0', B: '#48DBFB', C: '#FECA57', D: '#FF9F43', F: '#FF6B6B' }[t] || '#FF6B6B' }
        function tierLabel(t) { return { A: 'Excelente', B: 'Bueno', C: 'Regular', D: 'Bajo', F: 'Sin Score' }[t] || '--' }

        // ‚îÄ‚îÄ‚îÄ LOAD DATA ‚îÄ‚îÄ‚îÄ
        async function loadData() {
            document.getElementById('mainContent').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            try {
                const [mRes, sRes] = await Promise.all([
                    fetch(`${API}/api/dashboard/merchants`),
                    fetch(`${API}/api/score/stats/distribution`)
                ]);
                const mData = await mRes.json();
                const sData = await sRes.json();
                allMerchants = (mData.merchants || []).map(m => ({ ...m, tier: tierOf(m.nexo_score || 0) }));
                renderDashboard(allMerchants, sData);
            } catch (e) { console.error(e); showEmpty() }
        }

        function showEmpty() {
            document.getElementById('mainContent').innerHTML = `<div class="empty" style="padding-top:100px"><div class="ico">üìä</div><h3>Sin datos de cartera</h3><p>A√∫n no hay comerciantes registrados en NexoBot</p></div>`;
        }

        // ‚îÄ‚îÄ‚îÄ RENDER MAIN DASHBOARD ‚îÄ‚îÄ‚îÄ
        function renderDashboard(merchants, distData) {
            const scored = merchants.filter(m => m.nexo_score > 0);
            const totalDebt = merchants.reduce((s, m) => s + (m.total_credit_given || 0), 0);
            const totalSales = merchants.reduce((s, m) => s + (m.total_sales || 0), 0);
            const avgScore = scored.length > 0 ? Math.round(scored.reduce((s, m) => s + m.nexo_score, 0) / scored.length) : 0;
            const highRisk = merchants.filter(m => m.tier === 'D' || m.tier === 'F').length;
            const dist = distData?.distribution || { A: 0, B: 0, C: 0, D: 0, F: 0 };

            const now = new Date();
            const hour = (now.getUTCHours() - 3 + 24) % 24;
            const saludo = hour < 12 ? 'Buenos d√≠as' : hour < 18 ? 'Buenas tardes' : 'Buenas noches';

            document.getElementById('mainContent').innerHTML = `
                <div class="welcome-row anim">
                    <div class="welcome">
                        <h1>${saludo}, <em>Distribuidor</em> üè¢</h1>
                        <p>Gesti√≥n de cartera inteligente ‚Äî potenciada por NexoScore</p>
                    </div>
                    <div style="color:var(--text-muted);font-size:.75rem">Actualizado: ${now.toLocaleTimeString('es-PY', { hour: '2-digit', minute: '2-digit' })}</div>
                </div>

                <div class="stats-grid anim" style="animation-delay:.1s">
                    <div class="stat-card">
                        <div class="stat-icon" style="background:var(--accent-glow)">üè™</div>
                        <div class="stat-val">${merchants.length}</div>
                        <div class="stat-lbl">Comerciantes en cartera</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:var(--purple-bg)">üéØ</div>
                        <div class="stat-val">${avgScore}<span style="font-size:.7rem;color:var(--text-muted)">/1000</span></div>
                        <div class="stat-lbl">Score promedio cartera</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:var(--green-bg)">üí∞</div>
                        <div class="stat-val">${fPYG(totalSales)}</div>
                        <div class="stat-lbl">Ventas totales red</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:var(--red-bg)">üìã</div>
                        <div class="stat-val">${fPYG(totalDebt)}</div>
                        <div class="stat-lbl">Cr√©dito otorgado total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:var(--orange-bg)">‚ö†Ô∏è</div>
                        <div class="stat-val">${highRisk}</div>
                        <div class="stat-lbl">Comerciantes en riesgo</div>
                    </div>
                </div>

                <div class="grid-2 anim" style="animation-delay:.2s">
                    <div class="panel">
                        <div class="panel-hdr">
                            <div class="panel-title">üìä Distribuci√≥n NexoScore</div>
                            <span class="badge p">${scored.length} calificados</span>
                        </div>
                        <div id="tierDist">
                            ${renderTierDist(dist, merchants.length)}
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-hdr">
                            <div class="panel-title">üç© Riesgo de Cartera</div>
                            <span class="badge ${highRisk > 3 ? 'r' : 'g'}">${highRisk > 0 ? highRisk + ' en riesgo' : 'Cartera sana'}</span>
                        </div>
                        <div class="chart-box"><canvas id="riskChart"></canvas></div>
                    </div>
                </div>

                <div class="panel anim" style="animation-delay:.3s">
                    <div class="panel-hdr">
                        <div class="panel-title">üè™ Cartera de Comerciantes</div>
                        <span class="badge b">${merchants.length} total</span>
                    </div>
                    <div style="overflow-x:auto">
                        <table class="tbl" id="merchantTable">
                            <thead><tr>
                                <th>Comerciante</th>
                                <th>Ciudad</th>
                                <th>Rubro</th>
                                <th>NexoScore</th>
                                <th>Tier</th>
                                <th>Ventas</th>
                                <th>Cr√©dito</th>
                                <th>Desde</th>
                                <th></th>
                            </tr></thead>
                            <tbody id="merchantBody">
                                ${renderMerchantRows(merchants)}
                            </tbody>
                        </table>
                    </div>
                    ${merchants.length === 0 ? '<div class="empty"><div class="ico">üì±</div><h3>Sin comerciantes</h3><p>Los comerciantes aparecer√°n cuando usen NexoBot</p></div>' : ''}
                </div>
            `;
            renderRiskChart(dist);
        }

        // ‚îÄ‚îÄ‚îÄ TIER DISTRIBUTION BARS ‚îÄ‚îÄ‚îÄ
        function renderTierDist(dist, total) {
            const tiers = [
                { k: 'A', color: '#00D2A0', label: 'Excelente' },
                { k: 'B', color: '#48DBFB', label: 'Bueno' },
                { k: 'C', color: '#FECA57', label: 'Regular' },
                { k: 'D', color: '#FF9F43', label: 'Bajo' },
                { k: 'F', color: '#FF6B6B', label: 'Sin Score' }
            ];
            const max = Math.max(...Object.values(dist), 1);
            return tiers.map(t => {
                const count = dist[t.k] || 0;
                const pct = total > 0 ? Math.round(count / total * 100) : 0;
                const barW = Math.max(count / max * 100, count > 0 ? 8 : 0);
                return `<div class="tier-row">
                    <div class="label" style="color:${t.color}">${t.k}</div>
                    <div class="tier-bar"><div class="tier-bar-fill" style="width:${barW}%;background:${t.color}">${count > 0 ? count : ''}</div></div>
                    <div class="count">${pct}%</div>
                </div>`;
            }).join('');
        }

        // ‚îÄ‚îÄ‚îÄ MERCHANT TABLE ROWS ‚îÄ‚îÄ‚îÄ
        function renderMerchantRows(merchants) {
            if (merchants.length === 0) return '';
            return merchants.map(m => {
                const score = m.nexo_score || 0;
                const tier = tierOf(score);
                const color = tierColor(tier);
                const initials = (m.name || m.phone || '??').substring(0, 2).toUpperCase();
                return `<tr style="cursor:pointer" onclick="openMerchant('${m.id}','${m.phone}')">
                    <td><div class="name-cell">
                        <div class="avatar" style="background:${color}22;color:${color}">${initials}</div>
                        <div><div style="font-weight:600;font-size:.82rem">${m.name || 'Sin nombre'}</div><div style="font-size:.68rem;color:var(--text-muted)">${m.phone}</div></div>
                    </div></td>
                    <td style="color:var(--text-secondary)">${m.city || '-'}</td>
                    <td style="color:var(--text-secondary)">${m.business_type || '-'}</td>
                    <td><div class="score-mini">
                        <div class="score-bar"><div class="score-bar-fill" style="width:${score / 10}%;background:${color}"></div></div>
                        <span class="num" style="color:${color}">${score}</span>
                    </div></td>
                    <td><span class="tier-badge tier-${tier}">${tier} ¬∑ ${tierLabel(tier)}</span></td>
                    <td style="font-weight:600;font-variant-numeric:tabular-nums">${fPYG(m.total_sales || 0)}</td>
                    <td style="color:var(--red);font-weight:600">${fPYG(m.total_credit_given || 0)}</td>
                    <td style="color:var(--text-muted);font-size:.75rem">${fDate(m.created_at)}</td>
                    <td><button class="h-btn" style="padding:0 10px;height:28px;font-size:.7rem" onclick="event.stopPropagation();recalcOne('${m.id}')">üéØ</button></td>
                </tr>`;
            }).join('');
        }

        // ‚îÄ‚îÄ‚îÄ RISK DONUT CHART ‚îÄ‚îÄ‚îÄ
        function renderRiskChart(dist) {
            const ctx = document.getElementById('riskChart');
            if (!ctx) return;
            if (distChart) distChart.destroy();
            distChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['A ¬∑ Excelente', 'B ¬∑ Bueno', 'C ¬∑ Regular', 'D ¬∑ Bajo', 'F ¬∑ Sin Score'],
                    datasets: [{ data: [dist.A || 0, dist.B || 0, dist.C || 0, dist.D || 0, dist.F || 0], backgroundColor: ['rgba(0,210,160,0.7)', 'rgba(72,219,251,0.7)', 'rgba(254,202,87,0.7)', 'rgba(255,159,67,0.7)', 'rgba(255,107,107,0.7)'], borderColor: ['#00D2A0', '#48DBFB', '#FECA57', '#FF9F43', '#FF6B6B'], borderWidth: 2, hoverOffset: 6 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'right', labels: { color: '#8B95A5', font: { family: 'Inter', size: 11 }, boxWidth: 10, boxHeight: 10, borderRadius: 3, useBorderRadius: true, padding: 12 } }, tooltip: { backgroundColor: '#1B2236', titleColor: '#F0F2F5', bodyColor: '#8B95A5', borderColor: 'rgba(255,255,255,0.08)', borderWidth: 1, cornerRadius: 10, padding: 12 } } }
            });
        }

        // ‚îÄ‚îÄ‚îÄ MERCHANT DETAIL MODAL ‚îÄ‚îÄ‚îÄ
        async function openMerchant(id, phone) {
            const modal = document.getElementById('merchantModal');
            const content = document.getElementById('modalContent');
            modal.classList.add('show');
            content.innerHTML = '<div class="loading" style="padding:40px"><div class="spinner"></div></div>';
            try {
                const [dashRes, scoreRes] = await Promise.all([
                    fetch(`${API}/api/dashboard/${phone}`),
                    fetch(`${API}/api/score/calculate/${id}`, { method: 'POST' })
                ]);
                const dash = await dashRes.json();
                const scoreData = await scoreRes.json();
                const s = scoreData.data || {};
                const m = dash.merchant || {};
                const tier = s.tier?.grade || tierOf(s.score || 0);
                const color = tierColor(tier);
                const comps = s.components || {};

                content.innerHTML = `
                    <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px">
                        <div class="avatar" style="width:48px;height:48px;font-size:1.1rem;background:${color}22;color:${color}">${(m.name || '??').substring(0, 2).toUpperCase()}</div>
                        <div>
                            <h3 style="font-size:1.1rem;font-weight:700">${m.name || 'Sin nombre'}</h3>
                            <p style="font-size:.78rem;color:var(--text-secondary)">${m.business_name || m.phone} ¬∑ ${m.city || 'Paraguay'}</p>
                        </div>
                        <div style="margin-left:auto;text-align:center">
                            <div style="font-size:1.8rem;font-weight:900;color:${color}">${s.score || 0}</div>
                            <span class="tier-badge tier-${tier}" style="font-size:.72rem">${tier} ¬∑ ${tierLabel(tier)}</span>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px">
                        <div style="background:var(--bg-card-2);padding:12px;border-radius:10px;text-align:center">
                            <div style="font-size:1.1rem;font-weight:700">${fPYG(s.monthlySales || 0)}</div>
                            <div style="font-size:.7rem;color:var(--text-muted)">Ventas/mes</div>
                        </div>
                        <div style="background:var(--bg-card-2);padding:12px;border-radius:10px;text-align:center">
                            <div style="font-size:1.1rem;font-weight:700">${fPYG(s.creditLimit || 0)}</div>
                            <div style="font-size:.7rem;color:var(--text-muted)">L√≠mite cr√©dito</div>
                        </div>
                        <div style="background:var(--bg-card-2);padding:12px;border-radius:10px;text-align:center">
                            <div style="font-size:1.1rem;font-weight:700">${dash.stats?.totalCustomers || 0}</div>
                            <div style="font-size:.7rem;color:var(--text-muted)">Clientes</div>
                        </div>
                    </div>
                    <h4 style="font-size:.82rem;font-weight:600;margin-bottom:10px;color:var(--text-secondary)">üìä Componentes del Score</h4>
                    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px">
                        ${Object.entries(comps).map(([k, v]) => {
                    const norm = v?.normalized || 0;
                    const pct = Math.round(norm * 100);
                    const barColor = pct >= 70 ? 'var(--green)' : pct >= 40 ? 'var(--yellow)' : 'var(--red)';
                    return `<div style="display:flex;align-items:center;gap:8px;font-size:.75rem">
                                <span style="width:130px;color:var(--text-secondary)">${k.replace(/_/g, ' ')}</span>
                                <div style="flex:1;height:4px;background:rgba(255,255,255,0.06);border-radius:2px"><div style="height:100%;width:${pct}%;background:${barColor};border-radius:2px"></div></div>
                                <span style="width:32px;text-align:right;font-weight:600;color:${barColor}">${pct}%</span>
                            </div>`;
                }).join('')}
                    </div>
                    ${(s.alerts || []).length > 0 ? `
                        <h4 style="font-size:.82rem;font-weight:600;margin-bottom:8px;color:var(--red)">‚ö†Ô∏è Alertas</h4>
                        ${s.alerts.map(a => `<div class="alert-item"><div class="alert-icon" style="background:${a.type === 'critical' ? 'var(--red-bg)' : 'var(--yellow-bg)'}">‚ö†Ô∏è</div><div class="alert-text">${a.message}</div></div>`).join('')}
                    `: '<div style="font-size:.78rem;color:var(--green)">‚úÖ Sin alertas activas</div>'}
                `;
            } catch (e) {
                content.innerHTML = `<div class="empty"><h3>Error cargando datos</h3><p>${e.message}</p></div>`;
            }
        }

        function closeModal() { document.getElementById('merchantModal').classList.remove('show') }
        document.getElementById('merchantModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal() });

        // ‚îÄ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ
        document.getElementById('searchInput').addEventListener('input', e => {
            const q = e.target.value.toLowerCase();
            const filtered = q ? allMerchants.filter(m => (m.name || '').toLowerCase().includes(q) || (m.phone || '').includes(q) || (m.city || '').toLowerCase().includes(q) || (m.cedula || '').includes(q)) : allMerchants;
            const tbody = document.getElementById('merchantBody');
            if (tbody) tbody.innerHTML = renderMerchantRows(filtered);
        });

        // ‚îÄ‚îÄ‚îÄ RECALCULATE ‚îÄ‚îÄ‚îÄ
        async function recalcOne(id) {
            try {
                const res = await fetch(`${API}/api/score/calculate/${id}`, { method: 'POST' });
                const data = await res.json();
                if (data.data) { alert(`‚úÖ Score recalculado: ${data.data.score}/1000 (Tier ${data.data.tier?.grade})`); loadData(); }
            } catch (e) { alert('Error: ' + e.message) }
        }

        document.getElementById('recalcBtn').addEventListener('click', async () => {
            if (!confirm('¬øRecalcular NexoScore de TODOS los comerciantes? Esto puede tomar unos minutos.')) return;
            try {
                await fetch(`${API}/api/score/batch/recalculate`, { method: 'POST' });
                alert('‚úÖ Recalculaci√≥n masiva iniciada. Recarg√° en unos minutos para ver los resultados.');
            } catch (e) { alert('Error: ' + e.message) }
        });

        // ‚îÄ‚îÄ‚îÄ REFRESH ‚îÄ‚îÄ‚îÄ
        document.getElementById('refreshBtn').addEventListener('click', () => loadData());

        // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
        loadData();
        setInterval(loadData, 120000);
    </script>
</body>

</html>